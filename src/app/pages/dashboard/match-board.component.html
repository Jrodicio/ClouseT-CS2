<div class="custom-wrapper match-board-wrapper">
  <div class="board custom-card">
    <!-- Header -->
    <div class="board__header">
      <div class="state">
        <span>Estado:</span>
        <b>{{ match.estado }}</b>
      </div>

      <div class="meta">
        <span>Queue: <b>{{ queue.length }}/10</b></span>
        @if (match.map) {
          <span>Mapa: <b>{{ match.map }}</b></span>
        }
        @if (match.estado === 'armando_equipos') {
          <span>Turno: <b>{{ turn === 'team1' ? (match.team1?.name ?? 'Team A') : (match.team2?.name ?? 'Team B') }}</b></span>
        }
      </div>
    </div>

    @if (!showDetails) {
      <div class="board__locked">
        Estás fuera. Activá <b>Ver match</b> para ver el detalle.
      </div>
    } @else {
      <!-- Main 3 columns -->
      <div class="board__grid">
        <!-- LEFT: Team A -->
        <section class="col custom-card">
          <div class="col__title">{{ match.team1?.name ?? 'Team A' }}</div>

          <div class="stack">
            @for (id of teamA; track id) {
              <div
                class="player-card"
                [class.leader]="isLeaderA(id)"
              >
                @if (profileOf(id); as p) {
                  <img
                    class="avatar"
                    [class.leaderAvatar]="isLeaderA(id)"
                    [src]="p.avatar"
                    [attr.title]="p.personaName"
                    alt="avatar"
                  />
                  <div class="name">{{ p.personaName }}</div>
                }
              </div>
            }

            @if (teamA.length === 0) {
              <div class="hint">Vacío</div>
            }
          </div>
        </section>

        <!-- CENTER: varies by estado -->
        <section class="center custom-card">
          @switch (match.estado) {
          @case ('esperando_jugadores') {
            <div class="center__title">Jugadores en cola</div>

            <div class="centerGrid">
              @for (id of queue; track id) {
                <div class="player-card tile">
                  @if (profileOf(id); as p) {
                    <img class="avatar" [src]="p.avatar" [attr.title]="p.personaName" alt="avatar" />
                    <div class="name">{{ p.personaName }}</div>
                  }
                </div>
              }

              @if (queue.length === 0) {
                <div class="hint">No hay nadie todavía</div>
              }
            </div>
          }

          @case ('seleccionando_lideres') {
            <div class="center__title">Seleccionando líderes…</div>
            <div class="hint">En unos segundos se asignan 2 líderes y pasan a los equipos.</div>

            <div class="centerGrid">
              @for (id of queue; track id) {
                <div class="player-card tile">
                  @if (profileOf(id); as p) {
                    <img class="avatar" [src]="p.avatar" [attr.title]="p.personaName" alt="avatar" />
                    <div class="name">{{ p.personaName }}</div>
                  }
                </div>
              }
            </div>
          }

          @case ('armando_equipos') {
            <div class="center__title">Jugadores disponibles</div>

            @if (canPick) {
              <div class="hint">Es tu turno. Elegí un jugador haciendo click.</div>
            } @else {
              <div class="hint">Solo el líder del turno puede pickear.</div>
            }

            <div class="centerGrid">
              @for (id of availableIds; track id) {
                <div
                  class="player-card tile"
                  [class.selectable]="canPick && !busyPick"
                  [class.disabled]="!canPick || busyPick"
                  (click)="onPick(id)"
                >
                  @if (profileOf(id); as p) {
                    <img class="avatar" [src]="p.avatar" [attr.title]="p.personaName" alt="avatar" />
                    <div class="name">{{ p.personaName }}</div>
                  }
                </div>
              }

              @if (availableIds.length === 0) {
                <div class="hint">No hay disponibles</div>
              }
            </div>

            @if (pickErr) {
              <div class="err">
                {{ pickErr }}
              </div>
            }
          }

          @case ('seleccionando_mapa') {
            <div class="center__title">Baneo de mapas</div>
            <div class="hint">
              Turno: <b>{{ mapTurn === 'team1' ? (match.team1?.name ?? 'Team A') : (match.team2?.name ?? 'Team B') }}</b>
              · Bans: <b>{{ match.mapBanCount ?? 0 }}</b>
              · Restantes: <b>{{ mapPool.length - bannedMaps.length }}</b>
            </div>

            @if (canBan) {
              <div class="hint">Es tu turno. Elegí un mapa para banear.</div>
            } @else {
              <div class="hint">Solo el líder del turno puede banear.</div>
            }

            <div class="mapList">
              @for (m of mapPool; track m) {
                <div
                  class="mapRow"
                  [class.banned]="isBanned(m)"
                  [class.selectable]="canBan && !busyBan && !isBanned(m)"
                  (click)="onBanMap(m)"
                >
                  <div class="mapThumb"></div>
                  <div class="mapName">{{ m }}</div>
                </div>
              }
            </div>

            @if (banErr) {
              <div class="err">
                {{ banErr }}
              </div>
            }
          }

          @case ('en_curso') {
            <div class="center__title">Match en curso</div>

            <div class="mapCard">
              <div class="mapThumb big"></div>
              <div class="mapName big">{{ match.map ?? 'Mapa no definido' }}</div>

              @if (connection) {
                <a
                  class="btn primary"
                  [href]="isParticipant ? connection.connectUrl : connection.spectateUrl"
                >
                  {{ isParticipant ? 'Ingresar al servidor' : 'Ingresar como espectador' }}
                </a>
              }
            </div>

            @if (canFinalize) {
              <div class="hint" style="margin-top:12px;">
                Para reiniciar el match, ambos líderes deben confirmar.
              </div>

              <button
                class="btn"
                type="button"
                [disabled]="busyFinalize || hasFinalized"
                (click)="onFinalize()"
                style="margin-top:8px;width:100%;"
              >
                {{ hasFinalized ? 'Confirmado' : (busyFinalize ? 'Finalizando…' : 'Finalizar match') }}
              </button>

              @if (hasFinalized) {
                <div class="hint">Esperando confirmación del otro líder…</div>
              }

              @if (finalizeErr) {
                <div class="err">{{ finalizeErr }}</div>
              }
            }

            @if (canCancel) {
              <button
                class="btn danger"
                type="button"
                [disabled]="busyCancel"
                (click)="onCancel()"
                style="margin-top:8px;width:100%;"
              >
                {{ busyCancel ? 'Cancelando…' : 'Cancelar match' }}
              </button>

              @if (cancelErr) {
                <div class="err">{{ cancelErr }}</div>
              }
            }
          }
        }
      </section>

        <!-- RIGHT: Team B -->
        <section class="col custom-card">
          <div class="col__title">{{ match.team2?.name ?? 'Team B' }}</div>

          <div class="stack">
            @for (id of teamB; track id) {
              <div
                class="player-card"
                [class.leader]="isLeaderB(id)"
              >
                @if (profileOf(id); as p) {
                  <img
                    class="avatar"
                    [class.leaderAvatar]="isLeaderB(id)"
                    [src]="p.avatar"
                    [attr.title]="p.personaName"
                    alt="avatar"
                  />
                  <div class="name">{{ p.personaName }}</div>
                }
              </div>
            }

            @if (teamB.length === 0) {
              <div class="hint">Vacío</div>
            }
          </div>
        </section>
      </div>
    }
  </div>
</div>
