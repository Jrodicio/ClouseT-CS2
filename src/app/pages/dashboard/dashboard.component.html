<div class="dashboard">
  @if (auth.user$ | async; as user) {
    @if (steamIdFromUid(user.uid); as mySteamId) {
      <div class="dashboard-grid">
        <div class="dashboard-left">
          <!-- ================= LEFT: Mi Steam ================= -->
          <section class="custom-card">
            <div class="dashboard-profile">
              @if (profileOf(mySteamId); as me) {
                <img
                  [src]="me.avatar"
                  class="dashboard-avatar"
                  alt="avatar"
                />
                <div class="dashboard-profile-text">
                  <div class="dashboard-name">
                    {{ me.personaName }}
                  </div>
                  <div class="dashboard-meta">{{ me.steamId }}</div>
                  <a
                    [href]="me.profileUrl"
                    target="_blank"
                    rel="noreferrer"
                    class="dashboard-link"
                  >
                    Ver perfil
                  </a>
                </div>
              } @else {
                <div class="dashboard-muted">Cargando perfil Steam…</div>
              }
            </div>

            <div class="dashboard-status">
              @if (match$ | async; as match) {
                @switch (myStatus(match, mySteamId)) {
                  @case ('cola') {
                    <div class="dashboard-status-text">
                      Estado: <b>En cola</b>
                    </div>
                  }
                  @case ('team1') {
                    <div class="dashboard-status-text">
                      Estado: <b>En match (Team A)</b>
                    </div>
                  }
                  @case ('team2') {
                    <div class="dashboard-status-text">
                      Estado: <b>En match (Team B)</b>
                    </div>
                  }
                  @default {
                    <div class="dashboard-status-text">
                      Estado: <b>Fuera</b>
                    </div>
                  }
                }
              } @else {
                <div class="dashboard-muted">Cargando match…</div>
              }
            </div>

            <div class="dashboard-space-top">
              <button (click)="logout()" class="button-27">
                Logout
              </button>
            </div>
          </section>

          <!-- ================= LEFT: Acciones ================= -->
          <section class="custom-card">
            <h3 class="dashboard-actions-title">Acciones</h3>

            @if (match$ | async; as match) {
              @switch (match.estado) {
                @case ('esperando_jugadores') {
                  <div class="dashboard-muted dashboard-space-bottom">
                    Esperando jugadores ({{ match.queue.length }}/10)
                  </div>

                  @if (myStatus(match, mySteamId) === 'cola') {
                    <button
                      (click)="leave(match, mySteamId)"
                      class="button-27"
                    >
                      Salir del match
                    </button>
                  } @else {
                    <button
                      (click)="join(match, mySteamId)"
                      class="button-27"
                    >
                      Ingresar al match
                    </button>
                  }
                }

                @case ('seleccionando_lideres') {
                  <div class="dashboard-muted dashboard-space-bottom">
                    Seleccionando líderes…
                  </div>

                  @if (myStatus(match, mySteamId) === 'fuera') {
                    <button
                      (click)="toggleWatch()"
                      class="button-27"
                    >
                      {{ watchMatch ? 'Dejar de ver' : 'Ver match' }}
                    </button>

                    @if (!watchMatch) {
                      <div class="dashboard-note dashboard-space-top-sm">
                        Activá “Ver match” para ver el detalle del estado.
                      </div>
                    }
                  } @else {
                    <div class="dashboard-note">
                      Estás dentro. Vas a ver el estado completo a la derecha.
                    </div>
                  }
                }

                @case ('armando_equipos') {
                  <div class="dashboard-muted dashboard-space-bottom">
                    Armando equipos…
                  </div>

                  @if (myStatus(match, mySteamId) === 'fuera') {
                    <button
                      (click)="toggleWatch()"
                      class="button-27"
                    >
                      {{ watchMatch ? 'Dejar de ver' : 'Ver match' }}
                    </button>
                  } @else {
                    <div class="dashboard-note">
                      Seleccioná jugadores en el panel de la derecha.
                    </div>
                  }
                }

                @case ('seleccionando_mapa') {
                  <div class="dashboard-muted dashboard-space-bottom">
                    Baneando mapas…
                  </div>

                  @if (myStatus(match, mySteamId) === 'fuera') {
                    <button
                      (click)="toggleWatch()"
                      class="button-27"
                    >
                      {{ watchMatch ? 'Dejar de ver' : 'Ver match' }}
                    </button>
                  } @else {
                    <div class="dashboard-note">
                      Baneá mapas en el panel de la derecha.
                    </div>
                  }
                }

                @case ('en_curso') {
                  <div class="dashboard-muted dashboard-space-bottom">
                    Match en curso
                  </div>

                  <div class="dashboard-status-text dashboard-space-bottom">
                    Mapa: <b>{{ match.map ?? '—' }}</b>
                  </div>

                  @if (activeServerConnection; as connection) {
                    @if (myStatus(match, mySteamId) === 'fuera') {
                      <a
                        [href]="connection.spectateUrl"
                        class="dashboard-button dashboard-link-button"
                      >
                        Ingresar como espectador
                      </a>
                    } @else {
                      <a
                        [href]="connection.connectUrl"
                        class="dashboard-button dashboard-link-button"
                      >
                        Ingresar al servidor
                      </a>
                    }
                  }
                  @if (serverConnectionError) {
                    <div class="dashboard-error">
                      {{ serverConnectionError }}
                    </div>
                  }
                }
              }
            } @else {
              <div class="dashboard-muted">Cargando match…</div>
            }
          </section>
        </div>

        <!-- ================= RIGHT: Estado Match ================= -->
        <div class="dashboard-match">
          @if (match$ | async; as match) {
            <app-match-board
              [match]="match"
              [showDetails]="myStatus(match, mySteamId) !== 'fuera' || watchMatch"
              [profileOf]="profileOf.bind(this)"
              [leaderA]="match.team1?.players?.[0] ?? null"
              [leaderB]="match.team2?.players?.[0] ?? null"
              [mySteamId]="mySteamId"
              [connection]="activeServerConnection"
            />
          }
        </div>
      </div>
    } @else {
      <button (click)="logout()" class="button-27">Logoff</button>
      <div>No permitido login anónimo</div>
    }
  } @else {
    <p>Cargando sesión…</p>
  }
</div>
